{% extends "layouts/layout.html" %} {% block content %}
<div class="row mb-4">
  <div class="col-md-8">
    <h2>Finanzas</h2>
  </div>
  <div class="col-md-4 text-end">
    <a href="{{ url_for('main.finanzas.finanzas_diarias') }}" class="btn btn-primary">
      <i class="fas fa-calendar-day me-1"></i> Análisis Diario
    </a>
  </div>
</div>

<!-- Resumen de ingresos -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card text-white bg-success">
      <div class="card-body">
        <h5 class="card-title">Ingresos Totales Mensuales</h5>
        <h3 class="card-text">
          {{ "{:,.0f}".format(ingresos_mensual_total) }} COP
        </h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div
      class="card text-white"
      style="background: linear-gradient(135deg, #ff5f6d, #ffc371)"
    >
      <div class="card-body">
        <h5 class="card-title">Ingresos Membresías</h5>
        <h3 class="card-text">
          {{ "{:,.0f}".format(ingresos_mensual_membresias) }} COP
        </h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div
      class="card text-white"
      style="background: linear-gradient(135deg, #43cea2, #185a9d)"
    >
      <div class="card-body">
        <h5 class="card-title">Ingresos Productos</h5>
        <h3 class="card-text">
          {{ "{:,.0f}".format(ingresos_mensual_productos) }} COP
        </h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-white bg-info">
      <div class="card-body">
        <h5 class="card-title">Asistencias en el Mes</h5>
        <h3 class="card-text">{{ asistencias_mes }}</h3>
      </div>
    </div>
  </div>
</div>

<!-- Márgenes de Ganancia -->
<div class="row mb-4">
  <div class="col-md-4">
    <div class="card text-white" style="background-color: #ff6b6b">
      <div class="card-body">
        <h5 class="card-title">Margen de Ganancia (Hoy)</h5>
        <h3 class="card-text">{{ "{:,.0f}".format(margen_diario) }} COP</h3>
        <p class="mb-0">
          Ingresos: {{ "{:,.0f}".format(ingresos_diarios_total) }} COP
        </p>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card text-white" style="background-color: #4ecdc4">
      <div class="card-body">
        <h5 class="card-title">Margen de Ganancia (Semana)</h5>
        <h3 class="card-text">{{ "{:,.0f}".format(margen_semanal) }} COP</h3>
        <p class="mb-0">
          Ingresos: {{ "{:,.0f}".format(ingresos_semanales_total) }} COP
        </p>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card text-white" style="background-color: #6c5ce7">
      <div class="card-body">
        <h5 class="card-title">Margen de Ganancia (Mes)</h5>
        <h3 class="card-text">{{ "{:,.0f}".format(margen_mensual) }} COP</h3>
        <p class="mb-0">
          Ingresos: {{ "{:,.0f}".format(ingresos_mensual_total) }} COP
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Gráfico de Ingresos y Márgenes -->
<div class="row mb-4">
  <div class="col-md-8">
    <div class="card">
      <div class="card-header bg-primary text-white">
        <h5 class="card-title mb-0">Ingresos y Márgenes por Mes</h5>
      </div>
      <div class="card-body">
        <canvas id="graficoIngresos" height="300"></canvas>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card">
      <div class="card-header bg-info text-white">
        <h5 class="card-title mb-0">Distribución por Plan</h5>
      </div>
      <div class="card-body">
        <canvas id="graficoPlan" height="300"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="row mb-4">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header bg-success text-white">
        <h5 class="card-title mb-0">Productos Más Vendidos</h5>
      </div>
      <div class="card-body">
        <canvas id="graficoProductos" height="300"></canvas>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card">
      <div
        class="card-header"
        style="
          background: linear-gradient(135deg, #ff5f6d, #ffc371);
          color: white;
        "
      >
        <h5 class="card-title mb-0">Ingresos por Producto</h5>
      </div>
      <div class="card-body">
        <canvas id="graficoIngresosProductos" height="300"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-header bg-secondary text-white">
    <h5 class="card-title mb-0">Registro de Ingresos</h5>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Concepto</th>
            <th>Cliente</th>
            <th>Monto</th>
            <th>Método de Pago</th>
            <th>Fecha</th>
          </tr>
        </thead>
        <tbody>
          {% for pago in pagos %}
          <tr>
            <td>
              {% if pago.tipo == 'Membresía' %}
              <span class="badge bg-primary">{{ pago.tipo }}</span>
              {% else %}
              <span class="badge bg-success">{{ pago.tipo }}</span>
              {% endif %}
            </td>
            <td>
              {% if pago.usuario %} {{ pago.usuario.nombre }} {% else %}
              <span class="text-muted">Cliente no registrado</span>
              {% endif %}
            </td>
            <td class="text-end fw-bold">
              ${{ "{:,.0f}".format(pago.monto) }}
            </td>
            <td>
              {% if pago.metodo_pago is defined %} {{ pago.metodo_pago }} {%
              else %} {{ pago.usuario.metodo_pago }} {% endif %}
            </td>
            <td>{{ pago.fecha.strftime('%d/%m/%Y %H:%M') }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  <div class="card-footer text-center text-muted small">
    <div class="row">
      <div class="col-md-6 text-start">
        <span><i class="fas fa-code me-1"></i> Desarrollado por: YEIFRAN HERNANDEZ</span>
      </div>
      <div class="col-md-6 text-end">
        <span><i class="fas fa-brain me-1"></i> NEURALJIRA_DEV - Visión empresarial inteligente</span>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<!-- Cargar Chart.js con versión específica para evitar problemas de compatibilidad -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
  /**
   * MÓDULO DE GRÁFICOS FINANCIEROS
   * Desarrollado por: YEIFRAN HERNANDEZ
   * NEURALJIRA_DEV - Soluciones inteligentes para gimnasios
   * Última actualización: {{ now.strftime('%d/%m/%Y') }}
   */
  document.addEventListener('DOMContentLoaded', function() {
    try {
      console.log('Inicializando gráficos de finanzas...');
      // Función para parsear JSON de manera segura
      function parseJsonSafe(jsonString, defaultValue = []) {
        try {
          // Reemplazar NaN, Infinity y -Infinity con null para evitar errores de JSON
          const cleanedString = jsonString.replace(/NaN|Infinity|-Infinity/g, 'null');
          const parsedData = JSON.parse(cleanedString);
          
          // Verificar si hay valores especiales y convertirlos a 0
          if (Array.isArray(parsedData)) {
            return parsedData.map(item => {
              if (item === null || item === undefined || isNaN(item)) {
                return 0;
              }
              return item;
            });
          }
          return parsedData;
        } catch (error) {
          console.error("Error al parsear JSON:", error, jsonString);
          return defaultValue;
        }
      }

      // Obtener datos
      const meses = parseJsonSafe('{{ meses|tojson }}', []);
      const datosIngresosMembresias = parseJsonSafe('{{ datos_ingresos_membresias|tojson }}', []);
      const datosIngresosProductos = parseJsonSafe('{{ datos_ingresos_productos|tojson }}', []);
      const datosMargenes = parseJsonSafe('{{ datos_margenes|tojson }}', []);
      const planesNombres = parseJsonSafe('{{ planes_nombres|tojson }}', []);
      const datosPlanes = parseJsonSafe('{{ datos_planes|tojson }}', []);
      const productosNombres = parseJsonSafe('{{ productos_nombres|tojson }}', []);
      const productosCantidades = parseJsonSafe('{{ productos_cantidades|tojson }}', []);
      const productosIngresos = parseJsonSafe('{{ productos_ingresos|tojson }}', []);
      
      // Imprimir datos para depuración
      console.log('Datos de gráficos:', {
        meses, 
        datosIngresosMembresias, 
        datosIngresosProductos,
        datosMargenes,
        planesNombres,
        datosPlanes,
        productosNombres,
        productosCantidades,
        productosIngresos
      });

      // Función para crear gráficos de forma segura
      function crearGraficoSeguro(id, tipo, configuracion) {
        try {
          const elemento = document.getElementById(id);
          if (!elemento) {
            console.error(`Elemento con ID "${id}" no encontrado`);
            return null;
          }
          
          console.log(`Creando gráfico ${tipo} en ${id}`, configuracion);
          return new Chart(elemento.getContext('2d'), configuracion);
        } catch (error) {
          console.error(`Error al crear gráfico ${tipo} en ${id}:`, error);
          return null;
        }
      }
      
      // Gráfico de ingresos y márgenes
      if (meses.length > 0) {
        crearGraficoSeguro('graficoIngresos', 'bar', {
          type: 'bar',
          data: {
            labels: meses,
            datasets: [
              {
                label: 'Ingresos por Membresías (COP)',
                data: datosIngresosMembresias,
                backgroundColor: 'rgba(255, 95, 109, 0.6)',
                borderColor: 'rgba(255, 95, 109, 1)',
                borderWidth: 1
              },
              {
                label: 'Ingresos por Productos (COP)',
                data: datosIngresosProductos,
                backgroundColor: 'rgba(67, 206, 162, 0.6)',
                borderColor: 'rgba(67, 206, 162, 1)',
                borderWidth: 1
              },
              {
                label: 'Margen de Ganancia (COP)',
                data: datosMargenes,
                type: 'line',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 2,
                tension: 0.4,
                pointRadius: 4,
                pointBackgroundColor: 'rgba(75, 192, 192, 1)'
              }
            ]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return '$' + value.toLocaleString('es-CO');
                  }
                }
              }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return context.dataset.label + ': $' + context.parsed.y.toLocaleString('es-CO');
                  }
                }
              }
            }
          }
        });
      }

      // Gráfico distribución por plan
      if (planesNombres.length > 0 && datosPlanes.length > 0) {
        crearGraficoSeguro('graficoPlan', 'pie', {
          type: 'pie',
          data: {
            labels: planesNombres,
            datasets: [{
              label: 'Usuarios por plan',
              data: datosPlanes,
              backgroundColor: [
                'rgba(255, 99, 132, 0.6)',
                'rgba(54, 162, 235, 0.6)',
                'rgba(255, 206, 86, 0.6)',
                'rgba(75, 192, 192, 0.6)',
                'rgba(153, 102, 255, 0.6)'
              ],
              borderColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: 'right'
              }
            }
          }
        });
      }

      // Gráfico de productos más vendidos
      if (productosNombres.length > 0 && productosCantidades.length > 0) {
        crearGraficoSeguro('graficoProductos', 'bar', {
          type: 'bar',
          data: {
            labels: productosNombres,
            datasets: [{
              label: 'Cantidad Vendida',
              data: productosCantidades,
              backgroundColor: 'rgba(75, 192, 192, 0.6)',
              borderColor: 'rgba(75, 192, 192, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            indexAxis: 'y',
            scales: {
              x: {
                beginAtZero: true
              }
            }
          }
        });
      }

      // Gráfico de ingresos por producto
      if (productosNombres.length > 0 && productosIngresos.length > 0) {
        crearGraficoSeguro('graficoIngresosProductos', 'bar', {
          type: 'bar',
          data: {
            labels: productosNombres,
            datasets: [{
              label: 'Ingresos (COP)',
              data: productosIngresos,
              backgroundColor: 'rgba(255, 159, 64, 0.6)',
              borderColor: 'rgba(255, 159, 64, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            indexAxis: 'y',
            scales: {
              x: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return '$' + value.toLocaleString('es-CO');
                  }
                }
              }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    // Corregir para que funcione con el eje x horizontal para gráficos con indexAxis 'y'
                    if (context.parsed && typeof context.parsed.x !== 'undefined') {
                      return context.dataset.label + ': $' + context.parsed.x.toLocaleString('es-CO');
                    } else if (context.parsed && typeof context.parsed.y !== 'undefined') {
                      return context.dataset.label + ': $' + context.parsed.y.toLocaleString('es-CO');
                    } else {
                      return context.dataset.label + ': $0';
                    }
                  }
                }
              }
            }
          }
        });
      }

      // Añadimos mensaje de derechos reservados
      console.log('Gráficos financieros inicializados • © NEURALJIRA_DEV - YEIFRAN HERNANDEZ');
    } catch (error) {
      console.error("Error al inicializar gráficos:", error);
    }
  });
</script>

<!-- 
  NEURALJIRA_DEV - Transformando datos en visión de negocio
  Desarrollado por: YEIFRAN HERNANDEZ 
  Todos los derechos reservados © {{ now.year }} 
-->
{% endblock %}
